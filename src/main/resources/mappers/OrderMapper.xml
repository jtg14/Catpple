<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="portfolio.mapper.OrderMapper">
	
	<!-- 결재정보 추가 -->
	<insert id="insertPayment">
	insert  into payment values ((select ifnull(max(pNum),0)+1 from payment as pNum),#{pPrice},default,'신용카드')
	<selectKey keyProperty="pNum" resultType="int" order="AFTER">
		select LAST_INDEX_ID()
	</selectKey>
	</insert>
	<insert id="insertOandD">
	insert into corder (oNum,oDate,oPrice,oStock,oAddr1,oAddr2,oAddr3,oAddr4,oStatus,oName,oPhone,member_mId,goods_gNum) 
	values ((select ifnull(max(oNum),0)+1 from corder as onum),default,#{oPrice},#{oStock},#{oAddr1},#{oAddr2},#{oAddr3}
			,#{oAddr4},'주문완료',#{oName},#{oPhone},#{member_mId},#{goods_gNum});
	insert into delivery
	value((select ifnull(max(DPK),0)+1 from delivery as dp),'배송준비중',#{oAddr1},
	#{oAddr2},#{oAddr3},#{oAddr4},#{dInfo},LPAD((select ifnull(max(DPK),0)+1 from delivery as dp2),
	12 ,concat(DATE_FORMAT(current_timestamp,'%Y%m%d'),'000')),default,#{oNum});
	</insert>
	
	<select id ="findOrder" parameterType="int" resultType="OrderVO">
	select o.*,d.dInfo,d.dNum,p.pNum,p.ppayment,g.gName from corder o,payment p,
	delivery d,goods g where o.oNum = ${value} and p.corder_oNum = ${value}
	 and d.corder_oNum = ${value} and g.gnum = o.goods_gNum;
	</select>
</mapper>