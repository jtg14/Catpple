<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="portfolio.mapper.OrderMapper">
	<select id="getOrderList" resultType="vo.OrderVO">
		select o.*,g.gName,g.gImg1,g.member_mId sellerID from corder o,payment p,goods g where payment_pNum = #{pNum} and o.payment_pNum = p.pNum and o.goods_gNum = g.gNum
	</select>
	<select id="findPayment" resultType="vo.PaymentVO">
	select * from payment where pNum = #{pNum}
	</select>
	<select id="canceledList" resultType="vo.OrderVO">
	select DATE_FORMAT(o.oDate,'%Y-%m-%d %I:%i') oDate, o.oNum, o.oStock * o.oPrice as midPrice, o.oStatus, p.pPayment from corder o,payment p where o.payment_pNum = p.pNum and o.oStatus = 'os1' and o.member_mId = #{member_mId}
	</select>
	<select id="returnedList" resultType="vo.OrderVO">
	select g.gName, o.oPrice, o.oStock, o.oStatus from goods g,corder o where o.goods_gNum = g.gNum and o.oStatus = 'os2' and o.member_mId = #{member_mId}
	</select>
	
	<!-- 결재정보 추가 -->
	<insert id="insertPayment">
	insert  into payment (pPrice,pDate,pPayment) values (${pPrice},default,'신용카드')
	<selectKey keyProperty="pNum" resultType="integer" order="AFTER">
		SELECT LAST_INSERT_ID() as pNum
	</selectKey>
	</insert>
	
	<insert id="insertOandD" parameterType="java.util.HashMap">
	<foreach collection="olist" item="item">
	select @orderNumber:=(select ifnull(max(oNum),0)+1 from corder as onum);
	insert into corder (oNum,oDate,oPrice,oStock,oAddr1,oAddr2,oAddr3,oAddr4,oStatus,oName,oPhone,member_mId,goods_gNum,payment_pNum) 
	values (@orderNumber,default,${item.oPrice},${item.oStock},${item.oAddr1},'${item.oAddr2}','${item.oAddr3}',
			'${item.oAddr4}','os3','${item.oName}','${item.oPhone}','${item.member_mId}',${item.goods_gNum},${item.payment_pNum});
	insert into delivery
	value((select ifnull(max(DPK),0)+1 from delivery as dp),'a',${item.oAddr1},
	'${item.oAddr2}','${item.oAddr3}','${item.oAddr4}','${item.dInfo}',LPAD((select ifnull(max(DPK),0)+1 from delivery as dp2),
	12 ,concat(DATE_FORMAT(current_timestamp,'%Y%m%d'),'000')),default,@orderNumber);
	</foreach>
	</insert>
	<!-- 주문/배송조회 2-->
	<select id="oListInPnum" resultType="vo.OrderVO">
		select g.gimg1, g.gname, g.member_mid, g.gprice*o.ostock as midPrice, o.oNum, o.oStatus, m.mphone, d.dstate, d.dnum
		from goods as g, member as m, delivery as d, corder as o
		where o.goods_gnum= g.gnum and d.corder_onum=o.onum and m.mid=g.member_mid and o.member_mid=#{member_mId} and o.payment_pnum=#{pNum}
	</select>

	<!-- 판매자 받은 주문 목록 -->
	<select id="selectReceivedOrderList" resultType="vo.OrderVO">
		select g.gImg1, g.gStock, g.gName, g.gPrice, o.member_mid, o.oStock, o.oNum, o.oStatus,o.oDate, d.dState, d.dDate, d.dPk from goods as g, corder as o, delivery as d where g.gnum=o.goods_gnum and o.onum=d.corder_onum and d.dstate!='c' and g.member_mId=#{member_mId} order by o.oStatus desc, d.dState, o.oDate;
	</select>
	<!-- 판매자 배송완료 목록 -->
	<select id="selectDeliveryCompletionList" resultType="vo.OrderVO">
		 select g.gImg1, g.gStock, g.gName, g.gPrice, o.member_mid, o.oStock, o.oNum, o.oStatus,o.oDate, d.dState, d.dDate, d.dPk from goods as g, corder as o, delivery as d where g.gnum=o.goods_gnum and o.onum=d.corder_onum and d.dstate='c' and g.member_mId=#{member_mId} order by o.oStatus desc, d.dState, o.oDate;
	</select>
	
	<update id="changeDstate"  parameterType="java.util.List">
		update delivery set dState='b', dDate=default where dPk in
		<foreach collection="list" item="dpk" open="(" close=")" index="index" separator=",">
			${dPk}
		</foreach>
	</update>
	

	<update id="changeStatus">
	 update corder set oStatus = #{oStatus} where oNum = #{oNum}
	</update>
	
	<update id="changeDstateToD">
		UPDATE delivery AS d INNER JOIN corder AS o 
		ON d.corder_onum=o.onum
		SET d.dState = 'd'
		WHERE o.oStatus='os1';
	</update>

</mapper>