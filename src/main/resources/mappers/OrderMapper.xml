<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="portfolio.mapper.OrderMapper">
	<select id="getOrderList" resultType="vo.OrderVO">
		select o.*,g.gName,g.gImg1,g.member_mId sellerID from corder o,payment p,goods g where payment_pNum = #{pNum} and o.payment_pNum = p.pNum and o.goods_gNum = g.gNum
	</select>
	<select id="findPayment" resultType="vo.PaymentVO">
	select * from payment where pNum = #{pNum}
	</select>
	<!-- 결재정보 추가 -->
	<insert id="insertPayment">
	insert  into payment (pPrice,pDate,pPayment) values (${pPrice},default,'신용카드')
	<selectKey keyProperty="pNum" resultType="integer" order="AFTER">
		SELECT LAST_INSERT_ID() as pNum
	</selectKey>
	</insert>
	
	<insert id="insertOandD" parameterType="java.util.HashMap">
	<foreach collection="olist" item="item">
	select @orderNumber:=(select ifnull(max(oNum),0)+1 from corder as onum);
	insert into corder (oNum,oDate,oPrice,oStock,oAddr1,oAddr2,oAddr3,oAddr4,oStatus,oName,oPhone,member_mId,goods_gNum,payment_pNum) 
	values (@orderNumber,default,${item.oPrice},${item.oStock},${item.oAddr1},'${item.oAddr2}','${item.oAddr3}',
			'${item.oAddr4}','주문완료','${item.oName}','${item.oPhone}','${item.member_mId}',${item.goods_gNum},${item.payment_pNum});
	insert into delivery
	value((select ifnull(max(DPK),0)+1 from delivery as dp),'a',${item.oAddr1},
	'${item.oAddr2}','${item.oAddr3}','${item.oAddr4}','${item.dInfo}',LPAD((select ifnull(max(DPK),0)+1 from delivery as dp2),
	12 ,concat(DATE_FORMAT(current_timestamp,'%Y%m%d'),'000')),default,@orderNumber);
	</foreach>
	</insert>
	<!-- 주문/배송조회 2-->
	<select id="oListInPnum" resultType="vo.OrderVO">
		select g.gimg1, g.gname, g.member_mid, g.gprice*o.ostock as midPrice , m.mphone, d.dstate, d.dnum
		from goods as g, member as m, delivery as d, corder as o
		where o.goods_gnum= g.gnum and d.corder_onum=o.onum and m.mid=g.member_mid and o.member_mid=#{member_mId} and o.payment_pnum=#{pNum}
	</select>
	
</mapper>