<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="portfolio.mapper.OrderMapper">
<select id="insertOrder" resultType="vo.OrderVO">
start transaction;

select @orderNumber:=(select ifnull(max(oNum),0)+1 from corder as onum);
insert into corder values (@orderNumber,
		default,#{oPrice},#{oStock},#{oAddr1},#{oAddr2},#{oAddr3}
		,#{oAddr4},'주문완료',#{oPhone},#{member_mId},#{goods_gNum});
 insert  into payment values
		((select ifnull(max(pNum),0)+1 from payment as pNum),#{oPrice},default,'신용카드',
		@orderNumber);
insert into delivery
value((select ifnull(max(DPK),0)+1 from delivery as dp),'배송준비중',#{oAddr1},#{oAddr2},#{oAddr3},#{oAddr4},
#{dInfo},LPAD((select ifnull(max(DPK),0)+1 from delivery as dp2),12 ,concat(DATE_FORMAT(current_timestamp,'%Y%m%d'),'000')),default,@orderNumber);

select * from corder where onum = @orderNumber;
commit
	</select>
</mapper>